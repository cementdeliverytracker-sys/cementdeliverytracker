rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ===========================
    // HELPER FUNCTIONS
    // ===========================
    
    // Cached user data to avoid redundant get() calls
    function cachedUserData(uid) {
      return get(/databases/$(database)/documents/users/$(uid)).data;
    }
    
    // Get current user's cached data
    function currentUserData() {
      return cachedUserData(request.auth.uid);
    }
    
    // Get user type from cached data
    function getUserType(uid) {
      return cachedUserData(uid).userType;
    }
    
    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Check if user is superadmin
    function isSuperAdmin(uid) {
      return isAuthenticated() && getUserType(uid) == 'superadmin';
    }
    
    // Check if user is admin
    function isAdmin(uid) {
      return isAuthenticated() && getUserType(uid) == 'admin';
    }
    
    // Check if user is employee
    function isEmployee(uid) {
      return isAuthenticated() && getUserType(uid) == 'employee';
    }
    
    // Check if UID matches current user
    function isOwner(uid) {
      return request.auth.uid == uid;
    }
    
    // Validate that admin exists (for adminId references)
    function adminExists(adminId) {
      return exists(/databases/$(database)/documents/users/$(adminId)) 
        && cachedUserData(adminId).userType == 'admin';
    }
    
    // ===========================
    // USERS COLLECTION
    // ===========================
    
    match /users/{userId} {
      
      // === CREATE ===
      // Superadmin can create any user
      allow create: if isSuperAdmin(request.auth.uid);
      
      // Admin can create employees (must have valid adminId)
      allow create: if isAdmin(request.auth.uid)
        && request.resource.data.userType == 'employee'
        && request.resource.data.adminId == request.auth.uid;
      
      // === READ ===
      // Superadmin can read any user
      allow read: if isSuperAdmin(request.auth.uid);
      
      // User can read their own document
      allow read: if isOwner(userId);
      
      // Admin can read users in their team (adminId == request.auth.uid)
      allow read: if isAdmin(request.auth.uid)
        && resource.data.adminId == request.auth.uid;
      
      // === UPDATE ===
      // Superadmin can update any user
      allow update: if isSuperAdmin(request.auth.uid);
      
      // User can update their own document (but not userType or adminId)
      allow update: if isOwner(userId)
        && !request.resource.data.diff(resource.data)
          .affectedKeys().hasAny(['userType', 'adminId']);
      
      // Admin can update their team members (but not userType or adminId)
      allow update: if isAdmin(request.auth.uid)
        && resource.data.adminId == request.auth.uid
        && !request.resource.data.diff(resource.data)
          .affectedKeys().hasAny(['userType', 'adminId']);
      
      // === DELETE ===
      // Superadmin can delete any user
      allow delete: if isSuperAdmin(request.auth.uid);
      
      // Admin can delete their team members
      allow delete: if isAdmin(request.auth.uid)
        && resource.data.adminId == request.auth.uid;
      
      // Deny all other cases
      allow read, create, update, delete: if false;
    }
    
    // ===========================
    // ENTERPRISES COLLECTION
    // ===========================
    
    match /enterprises/{enterpriseId} {
      
      // === CREATE ===
      // Superadmin can create any enterprise
      allow create: if isSuperAdmin(request.auth.uid);
      
      // Admin can create their own enterprise (ownerId must match their UID)
      allow create: if isAdmin(request.auth.uid)
        && request.resource.data.ownerId == request.auth.uid;
      
      // === READ ===
      // Superadmin can read any enterprise
      allow read: if isSuperAdmin(request.auth.uid);
      
      // Admin can read their own enterprise
      allow read: if isAdmin(request.auth.uid)
        && resource.data.ownerId == request.auth.uid;
      
      // Employee can read their admin's enterprise (if admin exists)
      allow read: if isEmployee(request.auth.uid)
        && exists(/databases/$(database)/documents/users/$(currentUserData().adminId))
        && enterpriseId == currentUserData().adminId;
      
      // === UPDATE ===
      // Superadmin can update any enterprise
      allow update: if isSuperAdmin(request.auth.uid);
      
      // Admin can update their own enterprise (but not ownerId)
      allow update: if isAdmin(request.auth.uid)
        && resource.data.ownerId == request.auth.uid
        && request.resource.data.ownerId == resource.data.ownerId;
      
      // === DELETE ===
      // Superadmin can delete any enterprise
      allow delete: if isSuperAdmin(request.auth.uid);
      
      // Admin can delete their own enterprise
      allow delete: if isAdmin(request.auth.uid)
        && resource.data.ownerId == request.auth.uid;
      
      // Deny all other cases
      allow read, create, update, delete: if false;
    }
    
    // ===========================
    // CATCH-ALL DENY RULE
    // ===========================
    
    // Deny access to all other collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
