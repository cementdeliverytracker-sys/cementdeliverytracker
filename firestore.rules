rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ===========================
    // HELPER FUNCTIONS
    // ===========================
    
    // Cached user data to avoid redundant get() calls
    function cachedUserData(uid) {
      return get(/databases/$(database)/documents/users/$(uid)).data;
    }
    
    // Get current user's cached data
    function currentUserData() {
      return cachedUserData(request.auth.uid);
    }
    
    // Get user type from cached data
    function getUserType(uid) {
      return cachedUserData(uid).userType;
    }
    
    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Check if user is superadmin
    function isSuperAdmin(uid) {
      return isAuthenticated() && getUserType(uid) == 'super_admin';
    }
    
    // Check if user is admin
    function isAdmin(uid) {
      return isAuthenticated() && getUserType(uid) == 'admin';
    }
    
    // Check if user is employee
    function isEmployee(uid) {
      return isAuthenticated() && getUserType(uid) == 'employee';
    }
    
    // Check if UID matches current user
    function isOwner(uid) {
      return request.auth.uid == uid;
    }
    
    // ===========================
    // USERS COLLECTION
    // ===========================
    
    match /users/{userId} {
      
      // === CREATE ===
      // Superadmin can create any user
      allow create: if isSuperAdmin(request.auth.uid);
      
      // Admin can create employees (must have valid adminId)
      allow create: if isAdmin(request.auth.uid)
        && request.resource.data.userType == 'employee'
        && request.resource.data.adminId == request.auth.uid;
      
      // NEW USERS: Allow authenticated users to create their own document during signup
      // Must be creating their own userId and set userType to 'pending', 'pending_employee', or 'temp_employee'
      allow create: if isAuthenticated()
        && isOwner(userId)
        && request.resource.data.userType in ['pending', 'pending_employee', 'temp_employee']
        && request.resource.data.keys().hasAll(['email', 'username', 'userType']);
      
      // === READ ===
      // Superadmin can read any user
      allow read: if isSuperAdmin(request.auth.uid);
      
      // User can read their own document
      allow read: if isOwner(userId);
      
      // Admin can read users in their team (adminId == request.auth.uid)
      allow read: if isAdmin(request.auth.uid)
        && resource.data.adminId == request.auth.uid;
      
      // === UPDATE ===
      // Superadmin can update any user
      allow update: if isSuperAdmin(request.auth.uid);
      
      // User can update their own document (but not userType or adminId)
      allow update: if isOwner(userId)
        && !request.resource.data.diff(resource.data)
          .affectedKeys().hasAny(['userType', 'adminId']);
      
      // ROLE TRANSITION: temp_employee -> pending (admin request)
      allow update: if isOwner(userId)
        && resource.data.userType == 'temp_employee'
        && request.resource.data.userType == 'pending'
        && request.resource.data.keys().hasAll(['adminRequestData']);
      
      // ROLE TRANSITION: temp_employee -> pending_employee (employee join request)
      allow update: if isOwner(userId)
        && resource.data.userType == 'temp_employee'
        && request.resource.data.userType == 'pending_employee'
        && request.resource.data.keys().hasAll(['adminId', 'employeeRequestData']);
      
      // Admin can approve pending_employee requests (pending_employee -> employee)
      allow update: if isAdmin(request.auth.uid)
        && resource.data.adminId == request.auth.uid
        && resource.data.userType == 'pending_employee'
        && request.resource.data.userType == 'employee'
        && request.resource.data.adminId == request.auth.uid
        && request.resource.data.keys().hasAll(['employeeId']);
      
      // Admin can reject pending_employee requests (pending_employee -> temp_employee)
      allow update: if isAdmin(request.auth.uid)
        && resource.data.adminId == request.auth.uid
        && resource.data.userType == 'pending_employee'
        && request.resource.data.userType == 'temp_employee';

      // Admin can update their team members (but not userType or adminId)
      allow update: if isAdmin(request.auth.uid)
        && resource.data.adminId == request.auth.uid
        && !request.resource.data.diff(resource.data)
          .affectedKeys().hasAny(['userType', 'adminId']);

      // Admin can move their employee back to pending (removal flow)
      allow update: if isAdmin(request.auth.uid)
        && resource.data.adminId == request.auth.uid
        && request.resource.data.adminId == request.auth.uid
        && request.resource.data.userType == 'pending_employee';
      
      // === DELETE ===
      // Superadmin can delete any user
      allow delete: if isSuperAdmin(request.auth.uid);
      
      // Admin can delete their team members
      allow delete: if isAdmin(request.auth.uid)
        && resource.data.adminId == request.auth.uid;
      
      // Deny all other cases
      allow read, create, update, delete: if false;
    }
    
    // ===========================
    // ENTERPRISES COLLECTION
    // ===========================
    
    match /enterprises/{enterpriseId} {
      
      // === CREATE ===
      // Superadmin can create any enterprise
      allow create: if isSuperAdmin(request.auth.uid);
      
      // Admin can create their own enterprise (ownerId must match their UID)
      allow create: if isAdmin(request.auth.uid)
        && request.resource.data.ownerId == request.auth.uid;
      
      // === READ ===
      // Superadmin can read any enterprise
      allow read: if isSuperAdmin(request.auth.uid);
      
      // Authenticated user can read enterprise if ownerId matches their UID (Admin reading their own)
      allow read: if isAuthenticated()
        && resource.data.ownerId == request.auth.uid;
      
      // Employee can read their admin's enterprise using adminId reference
      allow read: if isAuthenticated()
        && currentUserData().get('adminId', '') == enterpriseId;
      
      // Authenticated users can query enterprises by adminCode (for employee join request)
      allow read: if isAuthenticated();
      
      // Allow querying enterprises to find by adminCode
      allow list: if isAuthenticated();
      
      // === UPDATE ===
      // Superadmin can update any enterprise
      allow update: if isSuperAdmin(request.auth.uid);
      
      // Admin can update their own enterprise (but not ownerId)
      // Location can only be set once (when locationSet changes from false to true)
      allow update: if isAuthenticated()
        && resource.data.ownerId == request.auth.uid
        && request.resource.data.ownerId == resource.data.ownerId
        && (
          // Allow location update only if locationSet is currently false
          !resource.data.get('locationSet', false)
          // Or allow updates that don't include location changes
          || !('location' in request.resource.data.diff(resource.data).affectedKeys())
        );
      
      // === DELETE ===
      // Superadmin can delete any enterprise
      allow delete: if isSuperAdmin(request.auth.uid);
      
      // Admin can delete their own enterprise
      allow delete: if isAdmin(request.auth.uid)
        && resource.data.ownerId == request.auth.uid;
      
      // Deny all other cases
      allow read, create, update, delete: if false;
    }
    
    // ===========================
    // DISTRIBUTORS COLLECTION
    // ===========================
    
    match /distributors/{distributorId} {
      
      // === CREATE ===
      // Superadmin can create any distributor
      allow create: if isSuperAdmin(request.auth.uid);
      
      // Admin can create distributors (adminId must match their UID)
      allow create: if isAdmin(request.auth.uid)
        && request.resource.data.adminId == request.auth.uid;
      
      // === READ ===
      // Superadmin can read any distributor
      allow read: if isSuperAdmin(request.auth.uid);
      
      // Admin can read their own distributors
      allow read: if isAdmin(request.auth.uid)
        && resource.data.adminId == request.auth.uid;
      
      // Employee can read their admin's distributors
      allow read: if isEmployee(request.auth.uid)
        && resource.data.adminId == currentUserData().adminId;
      
      // === UPDATE ===
      // Superadmin can update any distributor
      allow update: if isSuperAdmin(request.auth.uid);
      
      // Admin can update their own distributors (but not adminId)
      allow update: if isAdmin(request.auth.uid)
        && resource.data.adminId == request.auth.uid
        && request.resource.data.adminId == request.auth.uid;
      
      // === DELETE ===
      // Superadmin can delete any distributor
      allow delete: if isSuperAdmin(request.auth.uid);
      
      // Admin can delete their own distributors
      allow delete: if isAdmin(request.auth.uid)
        && resource.data.adminId == request.auth.uid;
      
      // Deny all other cases
      allow read, create, update, delete: if false;
    }
    
    // ===========================
    // ATTENDANCE LOGS COLLECTION
    // ===========================
    
    match /attendance_logs/{logId} {
      
      // === CREATE ===
      // Employee can create attendance log for themselves
      // Check that the employeeId matches the authenticated user
      allow create: if isAuthenticated()
        && request.resource.data.employeeId == request.auth.uid
        && request.resource.data.get('adminId', null) != null;
      
      // Admin can create attendance logs for their employees
      allow create: if isAdmin(request.auth.uid)
        && request.resource.data.adminId == request.auth.uid;
      
      // Superadmin can create any attendance log
      allow create: if isSuperAdmin(request.auth.uid);
      
      // === READ ===
      // Employee can read their own attendance logs
      allow read: if isEmployee(request.auth.uid)
        && resource.data.employeeId == request.auth.uid;
      
      // Admin can read their employees' attendance logs
      allow read: if isAdmin(request.auth.uid)
        && resource.data.adminId == request.auth.uid;
      
      // Superadmin can read any attendance log
      allow read: if isSuperAdmin(request.auth.uid);
      
      // === UPDATE ===
      // Superadmin can update any attendance log
      allow update: if isSuperAdmin(request.auth.uid)
        && request.resource.data.employeeId == resource.data.employeeId
        && request.resource.data.adminId == resource.data.adminId;
      
      // Deny all other updates
      allow update: if false;
      
      // === DELETE ===
      // Superadmin can delete any attendance log
      allow delete: if isSuperAdmin(request.auth.uid);
      
      // Admin can delete their employees' logs
      allow delete: if isAdmin(request.auth.uid)
        && resource.data.adminId == request.auth.uid;
      
      // Deny all other cases
      allow read, create, update, delete: if false;
    }
    
    // ===========================
    // CATCH-ALL DENY RULE
    // ===========================
    
    // Deny access to all other collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
